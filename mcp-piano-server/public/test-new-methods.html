<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test New Audio Engine Methods</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 10px;
        height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      .info {
        color: blue;
      }
    </style>
  </head>
  <body>
    <h1>ðŸŽ¹ Test New Audio Engine Methods</h1>

    <div class="container">
      <h2>Initialization</h2>
      <button id="initAudio">Initialize Audio Engine</button>
      <button id="startAudio" disabled>Start Audio Context</button>
      <div id="status">Ready to initialize</div>
    </div>

    <div class="container">
      <h2>Enhanced playNote Method Tests</h2>
      <button id="testMidiNote" disabled>
        Play MIDI Note (60, velocity 90)
      </button>
      <button id="testStringNote" disabled>
        Play String Note ("C4", velocity 0.7)
      </button>
      <button id="testVelocityRange" disabled>
        Test Velocity Range (-20 to 0 dB)
      </button>
      <button id="testDuration" disabled>Test Duration (2 seconds)</button>
    </div>

    <div class="container">
      <h2>New playChord Method Tests</h2>
      <button id="testChordBasic" disabled>Play C Major Chord</button>
      <button id="testChordDuration" disabled>Play Chord with Duration</button>
      <button id="testChordPhase" disabled>Test Phase Alignment</button>
    </div>

    <div class="container">
      <h2>Enhanced stopNote Method Tests</h2>
      <button id="testStopNote" disabled>Test stopNote with Fade</button>
      <button id="testStopNonExistent" disabled>Stop Non-existent Note</button>
    </div>

    <div class="container">
      <h2>Enhanced stopAll Method Tests</h2>
      <button id="testStopAll" disabled>
        Test stopAll with Multiple Notes
      </button>
      <button id="testStopAllScheduled" disabled>
        Test stopAll with Scheduled Events
      </button>
    </div>

    <div class="container">
      <h2>Console Log</h2>
      <div id="logOutput" class="log"></div>
      <button id="clearLog">Clear Log</button>
    </div>

    <!-- Load required scripts -->
    <script src="https://unpkg.com/tone@latest"></script>
    <script src="js/audio-engine.js"></script>

    <script>
      let audioEngine = null;
      const logOutput = document.getElementById("logOutput");
      const statusDiv = document.getElementById("status");

      // Logging function
      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement("div");
        logEntry.textContent = `[${timestamp}] ${message}`;
        logEntry.className = type;
        logOutput.appendChild(logEntry);
        logOutput.scrollTop = logOutput.scrollHeight;
        console.log(message);
      }

      // Update status
      function updateStatus(message, type = "info") {
        statusDiv.textContent = message;
        statusDiv.className = type;
      }

      // Initialize audio engine
      async function initializeAudio() {
        try {
          log("Initializing Piano Audio Engine...");
          updateStatus("Initializing...", "info");

          audioEngine = new PianoAudioEngine();
          const success = await audioEngine.initialize();

          if (success) {
            log("Audio engine initialized successfully", "success");
            updateStatus("Initialized - Click Start Audio Context", "success");
            document.getElementById("startAudio").disabled = false;
            document.getElementById("initAudio").disabled = true;
          } else {
            throw new Error("Failed to initialize audio engine");
          }
        } catch (error) {
          log(`Error initializing audio: ${error.message}`, "error");
          updateStatus("Initialization Failed", "error");
        }
      }

      // Start audio context
      async function startAudioContext() {
        try {
          log("Starting audio context...");
          updateStatus("Starting Audio Context...", "info");

          const success = await audioEngine.startAudioContext();

          if (success) {
            log("Audio context started successfully", "success");
            updateStatus("Audio Ready!", "success");
            document.getElementById("startAudio").disabled = true;

            // Enable all test buttons
            document.querySelectorAll("button[disabled]").forEach((btn) => {
              if (btn.id !== "initAudio" && btn.id !== "startAudio") {
                btn.disabled = false;
              }
            });
          } else {
            throw new Error("Failed to start audio context");
          }
        } catch (error) {
          log(`Error starting audio: ${error.message}`, "error");
          updateStatus("Audio Start Failed", "error");
        }
      }

      // Test enhanced playNote method with MIDI number
      function testMidiNote() {
        log("Testing playNote with MIDI number 60, velocity 90");
        const result = audioEngine.playNote(60, 90);
        log(`playNote result: ${result}`, result ? "success" : "error");

        setTimeout(() => {
          log("Stopping note with stopNote method");
          audioEngine.stopNote(60);
        }, 1500);
      }

      // Test playNote with string note name
      function testStringNote() {
        log('Testing playNote with string note "C4", velocity 0.7');
        const result = audioEngine.playNote("C4", 0.7);
        log(`playNote result: ${result}`, result ? "success" : "error");

        setTimeout(() => {
          log("Stopping note with stopNote method");
          audioEngine.stopNote("C4");
        }, 1500);
      }

      // Test velocity range mapping (-20 to 0 dB)
      function testVelocityRange() {
        log("Testing velocity range mapping to -20 to 0 dB");
        const velocities = [1, 32, 64, 96, 127]; // MIDI velocities

        velocities.forEach((velocity, index) => {
          setTimeout(() => {
            log(
              `Playing MIDI 60 with velocity ${velocity} (should map to ${
                -20 + (velocity / 127) * 20
              } dB)`
            );
            audioEngine.playNote(60, velocity);
            setTimeout(() => audioEngine.stopNote(60), 400);
          }, index * 600);
        });
      }

      // Test duration parameter
      function testDuration() {
        log("Testing playNote with 2-second duration (auto-release)");
        const result = audioEngine.playNote(60, 90, 2.0);
        log(
          `playNote with duration result: ${result}`,
          result ? "success" : "error"
        );
        log("Note should automatically release after 2 seconds");
      }

      // Test basic chord functionality
      function testChordBasic() {
        log("Testing playChord with C Major chord [60, 64, 67]");
        const midiNumbers = [60, 64, 67]; // C4, E4, G4
        const result = audioEngine.playChord(midiNumbers, 100);
        log(`playChord result: ${result}`, result ? "success" : "error");

        setTimeout(() => {
          log("Stopping chord notes individually");
          midiNumbers.forEach((midi) => audioEngine.stopNote(midi));
        }, 2000);
      }

      // Test chord with duration
      function testChordDuration() {
        log("Testing playChord with 1.5-second duration");
        const midiNumbers = [65, 69, 72]; // F Major chord
        const result = audioEngine.playChord(midiNumbers, 90, 1.5);
        log(
          `playChord with duration result: ${result}`,
          result ? "success" : "error"
        );
        log("Chord should automatically release after 1.5 seconds");
      }

      // Test phase alignment in chords
      function testChordPhase() {
        log("Testing phase alignment - playing same chord twice rapidly");
        const midiNumbers = [67, 71, 74]; // G Major chord

        // Play first chord
        audioEngine.playChord(midiNumbers, 80);
        log("First chord played");

        // Play second chord immediately (should not cause phase issues)
        setTimeout(() => {
          audioEngine.playChord(midiNumbers, 80);
          log("Second chord played (testing phase alignment)");

          setTimeout(() => {
            audioEngine.stopAll();
            log("All notes stopped");
          }, 1500);
        }, 100);
      }

      // Test stopNote with fade
      function testStopNote() {
        log("Testing stopNote with 50ms fade to avoid clicks");
        audioEngine.playNote(60, 90);
        log("Note started");

        setTimeout(() => {
          const result = audioEngine.stopNote(60);
          log(
            `stopNote result: ${result} (should include 50ms fade)`,
            result ? "success" : "error"
          );
        }, 1000);
      }

      // Test stopping non-existent note
      function testStopNonExistent() {
        log("Testing stopNote on non-existent note (should handle gracefully)");
        const result = audioEngine.stopNote(72); // C5, not currently playing
        log(
          `stopNote on non-existent note result: ${result}`,
          result ? "success" : "error"
        );
      }

      // Test stopAll with multiple notes
      function testStopAll() {
        log("Testing stopAll with multiple active notes");

        // Start multiple notes
        const notes = [60, 64, 67, 72, 76];
        notes.forEach((midi, index) => {
          setTimeout(() => {
            audioEngine.playNote(midi, 80);
            log(`Started note ${midi}`);
          }, index * 200);
        });

        // Stop all after 2 seconds
        setTimeout(() => {
          const activeCount = audioEngine.activeNotes.size;
          log(`Stopping all notes (${activeCount} active)`);
          const result = audioEngine.stopAll();
          log(`stopAll result: ${result}`, result ? "success" : "error");
        }, 2000);
      }

      // Test stopAll with scheduled events
      function testStopAllScheduled() {
        log("Testing stopAll with scheduled events (should clear transport)");

        // Schedule some notes using Tone.js Transport
        if (typeof Tone !== "undefined" && Tone.Transport) {
          Tone.Transport.scheduleRepeat(
            (time) => {
              audioEngine.playNote(60, 70, 0.5);
              log("Scheduled note played");
            },
            "0.5",
            "+0.5"
          );

          Tone.Transport.start();
          log("Transport started with scheduled events");

          setTimeout(() => {
            log("Calling stopAll (should clear scheduled events)");
            const result = audioEngine.stopAll();
            log(`stopAll result: ${result}`, result ? "success" : "error");
            log("Transport should be cleared");
          }, 3000);
        } else {
          log("Tone.js Transport not available", "error");
        }
      }

      // Event listeners
      document
        .getElementById("initAudio")
        .addEventListener("click", initializeAudio);
      document
        .getElementById("startAudio")
        .addEventListener("click", startAudioContext);
      document
        .getElementById("testMidiNote")
        .addEventListener("click", testMidiNote);
      document
        .getElementById("testStringNote")
        .addEventListener("click", testStringNote);
      document
        .getElementById("testVelocityRange")
        .addEventListener("click", testVelocityRange);
      document
        .getElementById("testDuration")
        .addEventListener("click", testDuration);
      document
        .getElementById("testChordBasic")
        .addEventListener("click", testChordBasic);
      document
        .getElementById("testChordDuration")
        .addEventListener("click", testChordDuration);
      document
        .getElementById("testChordPhase")
        .addEventListener("click", testChordPhase);
      document
        .getElementById("testStopNote")
        .addEventListener("click", testStopNote);
      document
        .getElementById("testStopNonExistent")
        .addEventListener("click", testStopNonExistent);
      document
        .getElementById("testStopAll")
        .addEventListener("click", testStopAll);
      document
        .getElementById("testStopAllScheduled")
        .addEventListener("click", testStopAllScheduled);
      document.getElementById("clearLog").addEventListener("click", () => {
        logOutput.innerHTML = "";
      });

      // Initial log
      log("New Audio Engine Methods Test Page Loaded");
      updateStatus("Ready to Initialize", "info");
    </script>
  </body>
</html>
